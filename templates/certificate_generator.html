<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generate Certificate</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .student-item { cursor: pointer; }
    .student-item:hover { background: #f8f9fa; }
    #results { max-height: 300px; overflow:auto; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Generate Student Certificate</h4>
      <a class="btn btn-outline-secondary" href="{{ url_for('students_list') }}">Back to students</a>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Search student (name / form no / phone)</label>
          <input id="search" class="form-control" placeholder="Type name or form no and press Enter or click a result" autocomplete="off" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Or enter Form No / ID</label>
          <input id="manualId" class="form-control" placeholder="ObjectId or formNo (e.g. A001)" />
        </div>

        <div class="col-md-3 text-end">
          <button id="generateBtn" class="btn btn-primary w-100">Generate Certificate</button>
        </div>
      </div>

      <div id="selectedCard" class="mt-3 d-none card card-body">
        <div id="selectedText"></div>
      </div>

      <div id="results" class="list-group mt-3" aria-live="polite"></div>
    </div>

    <div class="card p-3">
      <h6>Notes</h6>
      <ul>
        <li>The generator calls <code>/generate_certificate/&lt;id&gt;</code>. Pass either the student's ObjectId or their form number (as stored in DB).</li>
        <li>If PDF generation is available on server (pdfkit), it will download a PDF; otherwise it will render HTML in a new tab.</li>
      </ul>
    </div>

  </div>

<script>
  const searchEl = document.getElementById('search');
  const resultsEl = document.getElementById('results');
  const manualEl = document.getElementById('manualId');
  const generateBtn = document.getElementById('generateBtn');
  const selectedCard = document.getElementById('selectedCard');
  const selectedText = document.getElementById('selectedText');

  let selected = null; // {_id,name,form_no}

  // helper to render selected student
  function setSelected(obj){
    selected = obj;
    if(obj){
      selectedCard.classList.remove('d-none');
      selectedText.innerHTML = `<strong>Selected:</strong> ${escapeHtml(obj.name)} ${obj.form_no ? `<span class="text-muted">(${escapeHtml(obj.form_no)})</span>` : ''}`;
      manualEl.value = obj._id; // fill manual field with id for convenience
    } else {
      selectedCard.classList.add('d-none');
      selectedText.innerHTML = '';
    }
  }

  // basic escaping
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // Fetch search results (calls /api/all_students?q=... if available)
  async function search(q){
    resultsEl.innerHTML = '';
    setSelected(null);
    if(!q) return;
    try {
      const res = await fetch('/api/all_students?q=' + encodeURIComponent(q));
      if(!res.ok) throw new Error('Not ok');
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0){
        resultsEl.innerHTML = '<div class="p-2 text-muted">No results</div>';
        return;
      }
      data.forEach(s => {
        const a = document.createElement('a');
        a.className = 'list-group-item list-group-item-action student-item';
        a.innerHTML = `<div><strong>${escapeHtml(s.name)}</strong> <small class="text-muted">${escapeHtml(s.form_no || '')}</small></div>`;
        a.addEventListener('click', ()=> { setSelected(s); resultsEl.innerHTML = ''; searchEl.value = ''; });
        resultsEl.appendChild(a);
      });
    } catch (err){
      // If API not present, show minimal hint
      resultsEl.innerHTML = '<div class="p-2 text-muted">Search API not available. You can enter Form No or ObjectId directly in the ID field.</div>';
    }
  }

  // trigger search after Enter or 300ms debounce
  let timer = null;
  searchEl.addEventListener('input', (e)=> {
    clearTimeout(timer);
    const v = e.target.value.trim();
    timer = setTimeout(()=> search(v), 300);
  });
  searchEl.addEventListener('keydown', (e)=> {
    if(e.key === 'Enter'){ e.preventDefault(); search(searchEl.value.trim()); }
  });

  // generate button -> open in new tab
  generateBtn.addEventListener('click', ()=>{
    const manual = manualEl.value.trim();
    let id = manual;
    if(!id && selected) id = selected._id || selected.form_no;
    if(!id){
      alert('Enter a student ObjectId or Form No, or select a student from search.');
      return;
    }
    // open generate endpoint (server will either return PDF or HTML)
    const url = '/generate_certificate/' + encodeURIComponent(id);
    window.open(url, '_blank');
  });

  // clear selection when manual id changed
  manualEl.addEventListener('input', ()=> setSelected(null));
</script>
</body>
</html>
